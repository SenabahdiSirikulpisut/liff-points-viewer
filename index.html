<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>7-Eleven Membership</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Oxanium:wght@400;700&display=swap" rel="stylesheet">
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<style>
  body { font-family: 'Oxanium', cursive; background: #f8f9fa; color: #212529; display: flex; flex-direction: column; align-items: center; padding: 1rem; }
  h1 { font-size: 2.5rem; font-weight: 700; text-align: center; margin-bottom: 0.5rem; }
  #welcomeMsg { font-size: 1.2rem; font-weight: 500; margin-bottom: 1rem; text-align: center; }
  .flip-card { width: 100%; max-width: 400px; perspective: 1000px; margin-bottom: 2rem; }
  .flip-card-inner { position: relative; width: 100%; height: 300px; transition: transform 0.6s; transform-style: preserve-3d; }
  .flip-card.flip .flip-card-inner { transform: rotateY(180deg); }
  .flip-card-front, .flip-card-back { position: absolute; width: 100%; height: 100%; border-radius: 1rem; box-shadow: 0 4px 12px rgba(0,0,0,0.15); padding: 1.2rem; backface-visibility: hidden; display: flex; flex-direction: column; justify-content: space-between; color: #fff; }
  .flip-card-back { transform: rotateY(180deg); }
  .tier-silver { background: linear-gradient(135deg, #e0e0e0, #c0c0c0); color: #333; }
  .tier-gold { background: linear-gradient(135deg, #FFD700, #E6B800); color: #222; }
  .tier-black { background: linear-gradient(135deg, #080707, #1a1a1a); color: #fff; }
  .tier-badge { font-weight: 700; font-size: 0.9rem; padding: 0.3rem 0.6rem; }
  .points { font-size: 1.8rem; font-weight: 700; }
  .progress { height: 1.5rem; border-radius: 1rem; }
  .badge-star { font-size: 1.4rem; margin-right: 2px; }
  #coffeeBtn { width: 100%; max-width: 400px; margin-bottom: 2rem; }
  .streak { display: flex; justify-content: center; margin-top: 0.5rem; }
  .streak-day { width: 28px; height: 28px; border-radius: 50%; background: #ccc; color: #fff; display: flex; align-items: center; justify-content: center; margin: 0 2px; font-weight: bold; }
  .streak-active { background: #28a745; }
  .coupon { display: inline-block; margin: 4px; padding: 4px 6px; border-radius: 4px; background: #ffc107; color: #000; cursor: pointer; font-size: 0.85rem; }
  .coupon.redeemed { background: #6c757d; cursor: default; text-decoration: line-through; }
  @media (max-width: 576px) { .flip-card-front, .flip-card-back { padding: 1rem; } .points { font-size: 1.5rem; } #coffeeBtn { width: 100%; } }
</style>
</head>
<body>

<h1>7-Eleven Membership</h1>
<div id="welcomeMsg" style="display:none;"></div>
<div id="loading" class="text-secondary mb-3">Loading...</div>
<div id="error" class="text-danger mb-3"></div>

<div id="card" class="flip-card" style="display:none;" onclick="this.classList.toggle('flip')">
  <div class="flip-card-inner">
    <div id="cardFront" class="flip-card-front tier-silver text-center">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <span id="cardName" class="fs-5 fw-semibold">Member Name</span>
        <span id="tierBadge" class="badge tier-badge bg-light text-dark">Silver</span>
      </div>
      <div class="points mb-2">Points: <span id="cardPoints">0</span></div>
      <div id="cardBadges" class="mb-3"></div>
      <div class="progress mb-2">
        <div id="tierProgress" class="progress-bar bg-dark" role="progressbar" style="width: 0%;" aria-valuemin="0" aria-valuemax="100"></div>
      </div>
      <div id="progressText" class="fw-semibold mb-2"></div>
      <div class="streak" id="streakContainer"></div>
    </div>
    <div id="cardBack" class="flip-card-back tier-silver text-center">
      <h5>Coupons</h5>
      <div id="couponContainer"></div>
    </div>
  </div>
</div>

<button id="coffeeBtn" class="btn btn-primary btn-lg" style="display:none;">Record Coffee Purchase</button>

<script>
const BACKEND_URL = "https://script.google.com/macros/s/AKfycbyDH9bepmaNqXIfuz7D5Df_9FScWsxT3sdKWIRwHu6XVPJee_kPTuUkCVHlFlS5KGio/exec";
const LIFF_ID = "2007890960-Yjq6VQWo";

let currentUser = { userId: null, displayName: null };
const tierClasses = { "Silver":"tier-silver", "Gold":"tier-gold", "Black":"tier-black" };

async function main() {
  try {
    await liff.init({ liffId: LIFF_ID });
    if (!liff.isLoggedIn()) { liff.login(); return; }
    const profile = await liff.getProfile();
    currentUser.userId = profile.userId;
    currentUser.displayName = profile.displayName || "";
    await fetchAndRender();

    const coffeeBtn = document.getElementById("coffeeBtn");
    coffeeBtn.style.display = "block";
    coffeeBtn.onclick = async () => {
      let points = prompt("Enter points to award:");
      if (!points || isNaN(points)) { alert("Enter a valid number."); return; }
      points = Number(points);
      if (points <= 0) { alert("Points must be >0."); return; }

      const password = prompt("Enter staff password:");
      if (!password) return;

      await recordPurchase(points, password);
    };
  } catch (err) { showError(err.message || String(err)); }
}

async function fetchAndRender() {
  try {
    const res = await fetch(BACKEND_URL, {
      method: "POST",
      headers: { "Content-Type": "text/plain;charset=utf-8" },
      body: JSON.stringify({ userId: currentUser.userId, name: currentUser.displayName })
    });
    const data = await res.json();
    if (data.error) { showError(data.error); return; }
    renderUserData(data);
  } catch (err) { showError(err.message || String(err)); }
}

async function recordPurchase(points, password) {
  try {
    const res = await fetch(BACKEND_URL, {
      method: "POST",
      headers: { "Content-Type": "text/plain;charset=utf-8" },
      body: JSON.stringify({
        action: "record_purchase",
        userId: currentUser.userId,
        name: currentUser.displayName,
        points: points,
        password: password
      })
    });
    const data = await res.json();
    if (data.error) { alert("Error: " + data.error); return; }
    renderUserData(data);
    alert(`âœ… ${points} points recorded for ${data.name}. New total: ${data.points}`);
  } catch (err) {
    alert("Failed to record purchase: " + err.message);
    console.error(err);
  }
}

function renderUserData(data) {
  const tier = data.tier || "Silver";
  const points = data.points ?? 0;

  document.getElementById("welcomeMsg").textContent = `Welcome, ${data.name || currentUser.displayName || data.userId}`;
  document.getElementById("welcomeMsg").style.display = "block";

  document.getElementById("cardName").textContent = data.name || currentUser.displayName || data.userId;
  animatePoints(points);

  document.getElementById("cardFront").className = `flip-card-front ${tierClasses[tier]} text-center`;
  document.getElementById("cardBack").className = `flip-card-back ${tierClasses[tier]} text-center`;

  document.getElementById("tierBadge").textContent = tier;

  renderProgress(points);

  renderStreak(data.streakDay || 0);
  renderCoupons(data.coupons || {});

  document.getElementById("loading").style.display = "none";
  document.getElementById("card").style.display = "block";
  document.getElementById("coffeeBtn").style.display = "block";
  document.getElementById("error").textContent = "";
}

function animatePoints(newPoints) {
  const el = document.getElementById("cardPoints");
  let current = Number(el.textContent);
  const step = (newPoints - current) / 20;
  let i = 0;
  const interval = setInterval(() => {
    if (i++ >= 20) { el.textContent = newPoints; clearInterval(interval); }
    else el.textContent = Math.round(current + step * i);
  }, 20);
}

function renderProgress(points) {
  const progressBar = document.getElementById("tierProgress");
  const tierThresholds = [500, 1000];
  const nextTierPoints = tierThresholds.find(threshold => points < threshold) || 0;
  let percent = 0, text = 'Max tier reached';
  if (nextTierPoints > 0) { percent = Math.min((points / nextTierPoints) * 100, 100); text = `${nextTierPoints - points} points to next tier`; }
  else percent = 100;
  progressBar.style.width = percent + "%";
  document.getElementById("progressText").textContent = text;
}

function renderStreak(streakDay) {
  const container = document.getElementById("streakContainer");
  container.innerHTML = "";
  for (let i=1;i<=7;i++){
    const div = document.createElement("div");
    div.className = "streak-day" + (i<=streakDay ? " streak-active" : "");
    div.textContent = i;
    container.appendChild(div);
  }
}

function renderCoupons(coupons) {
  const container = document.getElementById("couponContainer");
  container.innerHTML = "";
  for (const [key,value] of Object.entries(coupons)){
    for(let i=0;i<value;i++){
      const c = document.createElement("span");
      c.className = "coupon";
      c.textContent = key;
      c.onclick = async () => {
        if(c.classList.contains("redeemed")) return;
        if(confirm(`Redeem 1 ${key}?`)){
          c.classList.add("redeemed");
          // TODO: optionally call backend to decrement coupon
        }
      };
      container.appendChild(c);
    }
  }
}

function showError(msg) {
  document.getElementById("loading").style.display = "none";
  document.getElementById("card").style.display = "none";
  document.getElementById("coffeeBtn").style.display = "none";
  document.getElementById("error").textContent = "Error: " + msg;
  console.error(msg);
}

main();
</script>
</body>
</html>






















