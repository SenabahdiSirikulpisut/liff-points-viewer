<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>7-Eleven Membership</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Oxanium:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body {
      font-family: 'Oxanium', cursive;
      background: #f8f9fa;
      color: #212529;
      overflow-x: hidden;
      padding-top: 1rem;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    h1 {
      font-size: 2.5rem;
      font-weight: 700;
      text-align: center;
      margin-bottom: 0.3rem;
    }

    #welcomeMsg {
      font-size: 1.2rem;
      font-weight: 600;
      margin-bottom: 1rem;
      text-align: center;
    }

    /* Flip Card */
    .flip-card {
      background-color: transparent;
      width: 350px;
      max-width: 90%;
      perspective: 1000px;
      margin-bottom: 1.5rem;
    }

    .flip-card-inner {
      position: relative;
      width: 100%;
      transition: transform 0.8s;
      transform-style: preserve-3d;
      cursor: pointer;
    }

    .flip-card.flip .flip-card-inner {
      transform: rotateY(180deg);
    }

    .flip-card-front, .flip-card-back {
      position: absolute;
      width: 100%;
      backface-visibility: hidden;
      border-radius: 1rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      padding: 1.5rem;
      display: flex;
      flex-direction: column;
      justify-content: center;
      color: #fff;
      min-height: 200px;
    }

    .flip-card-front {
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .flip-card-back {
      transform: rotateY(180deg);
      text-align: center;
    }

    .tier-silver { background: linear-gradient(135deg, #e0e0e0, #c0c0c0); color: #333; }
    .tier-gold { background: linear-gradient(135deg, #FFD700, #E6B800); color: #222; }
    .tier-black { background: linear-gradient(135deg, #272727, #3a3a3a); color: #fff; }

    .tier-badge {
      font-weight: 700;
      font-size: 0.9rem;
      padding: 0.3rem 0.6rem;
    }

    .points { 
      font-size: 2rem; 
      font-weight: 700; 
    }

    .progress { height: 1.5rem; border-radius: 1rem; margin-top: 0.5rem; }

    .badge-star { font-size: 1.4rem; margin-right: 2px; }

    #coffeeBtn {
      width: 350px;
      max-width: 90%;
      margin-bottom: 2rem;
    }

    @media (max-width: 576px) {
      .flip-card { width: 90%; }
      #coffeeBtn { width: 90%; }
      .points { font-size: 1.7rem; }
    }

  </style>
</head>
<body>

  <h1>7-Eleven Membership</h1>
  <div id="welcomeMsg"></div>

  <!-- Flip Card -->
  <div id="card" class="flip-card" style="display:none;" onclick="this.classList.toggle('flip')">
    <div class="flip-card-inner">
      <div id="cardFront" class="flip-card-front tier-silver text-center">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <span id="cardName" class="fs-5 fw-semibold">Member Name</span>
          <span id="tierBadge" class="badge tier-badge bg-light text-dark">Silver</span>
        </div>
        <div class="points mb-2">Points: <span id="cardPoints">0</span></div>
        <div id="cardBadges" class="mb-3"></div>
        <div class="progress mb-2">
          <div id="tierProgress" class="progress-bar bg-dark" role="progressbar" style="width: 0%;" aria-valuemin="0" aria-valuemax="100"></div>
        </div>
        <div id="progressText" class="fw-semibold"></div>
      </div>
      <div id="cardBack" class="flip-card-back tier-silver">
        <h5>Member Privileges</h5>
        <div id="cardPrivileges">No privileges yet</div>
      </div>
    </div>
  </div>

  <!-- Record Purchase Button -->
  <button id="coffeeBtn" class="btn btn-primary btn-lg" style="display:none;">Record Coffee Purchase</button>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    const BACKEND_URL = "https://script.google.com/macros/s/AKfycbzC-XpWbaNvjva6y7QEOhO-rJVlhCn0Q2z3Q6f0XW9jy3R5ugPAQsrsnoi73n4SWCnk/exec";
    const LIFF_ID = "2007890960-Yjq6VQWo";

    let currentUser = { userId: null, displayName: null };
    const tierClasses = { "Silver":"tier-silver", "Gold":"tier-gold", "Black":"tier-black" };

    async function main() {
      try {
        await liff.init({ liffId: LIFF_ID });
        if (!liff.isLoggedIn()) { liff.login(); return; }

        const profile = await liff.getProfile();
        currentUser.userId = profile.userId;
        currentUser.displayName = profile.displayName || "";

        await fetchAndRender();

        const coffeeBtn = document.getElementById("coffeeBtn");
        coffeeBtn.style.display = "block";
        coffeeBtn.onclick = async () => {
          const password = prompt("Enter password to record coffee purchase:");
          if (!password) return;
          await recordCoffeePurchase(password);
        };

      } catch (err) { showError(err.message || String(err)); }
    }

    async function fetchAndRender() {
      try {
        const res = await fetch(BACKEND_URL, {
          method: "POST",
          headers: { "Content-Type": "text/plain;charset=utf-8" },
          body: JSON.stringify({ userId: currentUser.userId, name: currentUser.displayName })
        });
        if (!res.ok) throw new Error("Network response not ok: " + res.status);
        const data = await res.json();
        if (data.error) { showError(data.error); return; }
        renderUserData(data);
      } catch (err) { showError(err.message || String(err)); }
    }

    async function recordCoffeePurchase(password) {
      try {
        const res = await fetch(BACKEND_URL, {
          method: "POST",
          headers: { "Content-Type": "text/plain;charset=utf-8" },
          body: JSON.stringify({ 
            userId: currentUser.userId, 
            name: currentUser.displayName, 
            action: "coffee_purchase",
            password
          })
        });
        if (!res.ok) throw new Error("Network response not ok: " + res.status);
        const data = await res.json();
        if (data.error) { alert("Error: " + data.error); return; }
        renderUserData(data);
        alert("Coffee purchase recorded! Points updated.");
      } catch (err) {
        alert("Failed to record purchase: " + err.message);
        console.error(err);
      }
    }

    function renderUserData(data) {
      const tier = data.tier || "Silver";
      const points = data.points ?? 0;

      document.getElementById("welcomeMsg").textContent = `Welcome, ${data.name || currentUser.displayName || data.userId}`;

      document.getElementById("cardName").textContent = data.name || currentUser.displayName || data.userId;
      document.getElementById("tierBadge").textContent = tier;

      // Apply tier gradient to both sides
      const cardFront = document.getElementById("cardFront");
      const cardBack = document.getElementById("cardBack");
      cardFront.className = "flip-card-front text-center " + (tierClasses[tier] || tierClasses["Silver"]);
      cardBack.className = "flip-card-back " + (tierClasses[tier] || tierClasses["Silver"]);

      animatePoints(points);
      renderProgress(points);

      const badges = (data.badges || "").split(",").map(b => b.trim()).filter(Boolean);
      document.getElementById("cardBadges").innerHTML = badges.map(b => `<span class="badge badge-star text-warning">‚≠ê</span>`).join("");

      const privileges = (data.privileges || "").split(",").map(p => p.trim()).filter(Boolean);
      document.getElementById("cardPrivileges").innerHTML = privileges.length ? privileges.join("<br>") : "No privileges yet";

      document.getElementById("card").style.display = "block";
      document.getElementById("coffeeBtn").style.display = "block";
      document.getElementById("loading")?.remove();
      document.getElementById("error").textContent = "";
    }

    function animatePoints(newPoints) {
      const el = document.getElementById("cardPoints");
      let current = Number(el.textContent);
      const step = (newPoints - current) / 20;
      let i = 0;
      const interval = setInterval(() => {
        if (i++ >= 20) { el.textContent = newPoints; clearInterval(interval); }
        else el.textContent = Math.round(current + step * i);
      }, 20);
    }

    function renderProgress(points) {
      const progressBar = document.getElementById("tierProgress");
      let percent = Math.min(points, 100);
      progressBar.style.width = percent + "%";

      let nextTierPoints = 0;
      if (points < 50) nextTierPoints = 50 - points;
      else if (points < 100) nextTierPoints = 100 - points;
      else nextTierPoints = 0;

      document.getElementById("progressText").textContent = nextTierPoints > 0 ? `${nextTierPoints} points to next tier` : 'Max tier reached';
    }

    function showError(msg) {
      document.getElementById("loading")?.remove();
      document.getElementById("card").style.display = "none";
      document.getElementById("coffeeBtn").style.display = "none";
      document.getElementById("error").textContent = "Error: " + msg;
      console.error(msg);
    }

    main();
  </script>

</body>
</html>
