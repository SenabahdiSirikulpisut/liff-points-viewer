<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>7-Eleven Membership</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Oxanium:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body {
      font-family: 'Oxanium', cursive;
      background: #f8f9fa;
      color: #212529;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 1rem;
    }

    h1 {
      font-size: 2.5rem;
      font-weight: 700;
      text-align: center;
      margin-bottom: 0.5rem;
    }

    #welcomeMsg {
      font-size: 1.2rem;
      font-weight: 500;
      margin-bottom: 1rem;
      text-align: center;
    }

    .flip-card {
      width: 100%;
      max-width: 400px;
      perspective: 1000px;
      margin-bottom: 1.5rem;
    }

    .flip-card-inner {
      position: relative;
      width: 100%;
      height: 250px; /* fixed height to cover gradient */
      transition: transform 0.6s;
      transform-style: preserve-3d;
    }

    .flip-card.flip .flip-card-inner {
      transform: rotateY(180deg);
    }

    .flip-card-front, .flip-card-back {
      position: absolute;
      width: 100%;
      height: 100%;
      border-radius: 1rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      padding: 1.2rem;
      backface-visibility: hidden;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      color: #fff;
    }

    .flip-card-back { transform: rotateY(180deg); }

    .tier-silver { background: linear-gradient(135deg, #e0e0e0, #c0c0c0); color: #333; }
    .tier-gold { background: linear-gradient(135deg, #FFD700, #E6B800); color: #222; }
    .tier-black { background: linear-gradient(135deg, #080707, #1a1a1a); color: #fff; }

    .tier-badge { font-weight: 700; font-size: 0.9rem; padding: 0.3rem 0.6rem; }
    .points { font-size: 1.8rem; font-weight: 700; }
    .progress { height: 1.5rem; border-radius: 1rem; }
    .badge-star { font-size: 1.4rem; margin-right: 2px; }

    .action-buttons {
      display: flex;
      justify-content: space-between;
      max-width: 400px;
      width: 100%;
      gap: 0.5rem;
      margin-bottom: 2rem;
    }

    .action-buttons .btn-group {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      flex: 1;
    }

    @media (max-width: 576px) {
      .flip-card-front, .flip-card-back { padding: 1rem; }
      .points { font-size: 1.5rem; }
      .action-buttons { flex-direction: column; gap: 0.5rem; }
      .action-buttons .btn-group { flex-direction: row; gap: 0.5rem; }
    }
  </style>
</head>
<body>

<h1>7-Eleven Membership</h1>
<div id="welcomeMsg" style="display:none;"></div>
<div id="loading" class="text-secondary mb-3">Loading...</div>
<div id="error" class="text-danger mb-3"></div>

<!-- Flip Card -->
<div id="card" class="flip-card" style="display:none;" onclick="this.classList.toggle('flip')">
  <div class="flip-card-inner">
    <div id="cardFront" class="flip-card-front tier-silver text-center">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <span id="cardName" class="fs-5 fw-semibold">Member Name</span>
        <span id="tierBadge" class="badge tier-badge bg-light text-dark">Silver</span>
      </div>
      <div class="points mb-2">Points: <span id="cardPoints">0</span></div>
      <div id="cardBadges" class="mb-3"></div>
      <div class="progress mb-2">
        <div id="tierProgress" class="progress-bar bg-dark" role="progressbar" style="width: 0%;" aria-valuemin="0" aria-valuemax="100"></div>
      </div>
      <div id="progressText" class="fw-semibold"></div>
    </div>
    <div id="cardBack" class="flip-card-back tier-silver text-center">
      <h5>Privileges</h5>
      <ul id="cardPrivileges" class="list-unstyled mb-0"></ul>
    </div>
  </div>
</div>

<!-- Action Buttons -->
<div class="action-buttons" id="actionButtons" style="display:none;">
  <div class="btn-group">
    <button class="btn btn-primary btn-lg" onclick="handleAction('coffee')">All Cafe (+5 pts)</button>
    <button class="btn btn-primary btn-lg" onclick="handleAction('select')">All Select (+10 pts)</button>
  </div>
  <div class="btn-group">
    <button class="btn btn-success btn-lg" onclick="handleAction('bakery')">+ Bakery (+15 pts)</button>
    <button class="btn btn-success btn-lg" onclick="handleAction('foodbox')">+ Food Box (+15 pts)</button>
  </div>
</div>

<script>
const BACKEND_URL = "https://script.google.com/macros/s/AKfycbzNaXm23i1ayzpEl1fBABCgoSuPU3TFpIT8vDc81ZJB0RTQ0hc5XmXbAGgoIuXt3dfJ/exec";
let currentUser = { userId: null, displayName: null };

async function main() {
  try {
    await liff.init({ liffId: "2007890960-Yjq6VQWo" });
    if (!liff.isLoggedIn()) { liff.login(); return; }

    const profile = await liff.getProfile();
    currentUser.userId = profile.userId;
    currentUser.displayName = profile.displayName || "";

    await fetchAndRender();
  } catch (err) { showError(err.message || String(err)); }
}

async function fetchAndRender() {
  try {
    const res = await fetch(BACKEND_URL, {
      method: "POST",
      headers: { "Content-Type": "text/plain;charset=utf-8" },
      body: JSON.stringify({ userId: currentUser.userId, name: currentUser.displayName })
    });
    if (!res.ok) throw new Error("Network response not ok: " + res.status);
    const data = await res.json();
    if (data.error) { showError(data.error); return; }
    renderUserData(data);
  } catch (err) { showError(err.message || String(err)); }
}

async function handleAction(action) {
  const password = prompt(`Enter password for ${action}:`);
  if (!password) return;

  try {
    const res = await fetch(BACKEND_URL, {
      method: "POST",
      headers: { "Content-Type": "text/plain;charset=utf-8" },
      body: JSON.stringify({ 
        userId: currentUser.userId,
        name: currentUser.displayName,
        action,
        password
      })
    });
    if (!res.ok) throw new Error("Network response not ok: " + res.status);
    const data = await res.json();
    if (data.error) { alert("Error: " + data.error); return; }
    renderUserData(data);
    alert(`${action} purchase recorded! Points updated.`);
  } catch (err) {
    alert("Failed to record purchase: " + err.message);
    console.error(err);
  }
}

function renderUserData(data) {
  const tierClasses = { "Silver":"tier-silver", "Gold":"tier-gold", "Black":"tier-black" };
  const privilegesByTier = {
    "Silver": ["10% off coffee", "Monthly newsletter"],
    "Gold": ["20% off coffee", "Exclusive events", "Birthday gift"],
    "Black": ["30% off coffee", "VIP access", "Free delivery", "Birthday gift"]
  };

  const tier = data.tier || "Silver";
  const points = data.points ?? 0;

  const welcomeMsg = document.getElementById("welcomeMsg");
  welcomeMsg.textContent = `Welcome, ${data.name || currentUser.displayName || data.userId}`;
  welcomeMsg.style.display = "block";

  document.getElementById("cardName").textContent = data.name || currentUser.displayName || data.userId;

  const cardFront = document.getElementById("cardFront");
  const cardBack = document.getElementById("cardBack");

  cardFront.className = `flip-card-front ${tierClasses[tier]} text-center`;
  cardBack.className = `flip-card-back ${tierClasses[tier]} text-center`;

  document.getElementById("tierBadge").textContent = tier;

  document.getElementById("cardPoints").textContent = points;
  const badges = (data.badges || "").split(",").map(b => b.trim()).filter(Boolean);
  document.getElementById("cardBadges").innerHTML = badges.map(b => `<span class="badge badge-star text-warning">‚≠ê</span>`).join("");

  const privList = document.getElementById("cardPrivileges");
  privList.innerHTML = '';
  (privilegesByTier[tier] || []).forEach(p => {
    const li = document.createElement('li');
    li.textContent = p;
    privList.appendChild(li);
  });

  document.getElementById("loading").style.display = "none";
  document.getElementById("card").style.display = "block";
  document.getElementById("actionButtons").style.display = "flex";
  document.getElementById("error").textContent = "";
}

function showError(msg) {
  document.getElementById("loading").style.display = "none";
  document.getElementById("card").style.display = "none";
  document.getElementById("actionButtons").style.display = "none";
  document.getElementById("error").textContent = "Error: " + msg;
  console.error(msg);
}

main();
</script>
</body>
</html>



